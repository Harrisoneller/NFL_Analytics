pass_ypa =  sum(passing_yards,na.rm = TRUE)/sum(pass_attempt,na.rm = TRUE)
)
df_off <- pbp %>%
filter(season_type == "REG", down %in% c(1, 2, 3, 4), punt_attempt == 0) %>%
group_by(posteam, game_id )%>%
summarise(
OFF_EPA = mean(epa, na.rm = TRUE),
QB_EPA = mean(qb_epa,na.rm = TRUE),
QB = max(passer_player_name,na.rm = TRUE),
fumble = sum(fumble_lost),
interception = sum(interception),
pass_ypa = sum(passing_yards,na.rm = TRUE)/sum(pass_attempt,na.rm = TRUE),
rush_ypa = sum(rushing_yards,na.rm = TRUE)/sum(rush_attempt,na.rm = TRUE),
pass_yds = sum(passing_yards,na.rm = TRUE),
rush_yds = sum(rushing_yards,na.rm = TRUE),
ypp = sum(sum(rushing_yards,na.rm = TRUE) + sum(passing_yards,na.rm = TRUE))/n(),
drives = max(drive,na.rm = TRUE)/2,
#    home_points = max(home_score,na.rm = TRUE),
#    away_points = max(away_score,na.rm = TRUE),
home_team = max(home_team,na.rm = TRUE),
pressures_allowed = (sum(sack,na.rm = TRUE)+sum(qb_hit,na.rm = TRUE) ),
total_plays_off = n(),
points = if_else(max(posteam,na.rm = TRUE) == max(home_team,na.rm = TRUE), max(home_score,na.rm = TRUE),max(away_score,na.rm = TRUE))
)
df_def<- pbp %>%
filter(season_type == "REG", down %in% c(1, 2, 3, 4), punt_attempt == 0) %>%
group_by(defteam, game_id )%>%
summarise(
OFF_EPA_allowed = mean(epa, na.rm = TRUE),
QB_EPA_allowed = mean(qb_epa,na.rm = TRUE),
#QB = max(passer_player_name,na.rm = TRUE),
fumbles_forced = sum(fumble_lost),
interceptions_forced = sum(interception),
pass_ypa_allowed = sum(passing_yards,na.rm = TRUE)/sum(pass_attempt,na.rm = TRUE),
rush_ypa_allowed = sum(rushing_yards,na.rm = TRUE)/sum(rush_attempt,na.rm = TRUE),
pass_yds_allowed = sum(passing_yards,na.rm = TRUE),
rush_yds_allowed = sum(rushing_yards,na.rm = TRUE),
ypp_allowed = sum(sum(rushing_yards,na.rm = TRUE) + sum(passing_yards,na.rm = TRUE))/n(),
drives_allowed = max(drive,na.rm = TRUE)/2,
#    home_points = max(home_score,na.rm = TRUE),
#    away_points = max(away_score,na.rm = TRUE),
away_team = max(away_team,na.rm = TRUE),
pressures_forced = (sum(sack,na.rm = TRUE)+sum(qb_hit,na.rm = TRUE) ),
total_plays_def = n(),
points_allowed = if_else(max(defteam,na.rm = TRUE) == max(home_team,na.rm = TRUE), max(away_score,na.rm = TRUE),max(home_score,na.rm = TRUE))
)
off <- df %>%
group_by(posteam) %>%
summarise(
EPA = median(OFF_EPA),
ypp = median(ypp),
pass_ypa = median(pass_ypa),
rush_ypa = median(rush_ypa),
turnovers = median(interception)+median(fumble)
)
View(df)
df<-cbind(df_off,df_def)
off <- df %>%
group_by(posteam) %>%
summarise(
EPA = median(OFF_EPA),
ypp = median(ypp),
pass_ypa = median(pass_ypa),
rush_ypa = median(rush_ypa),
turnovers = median(interception)+median(fumble)
)
def <- df %>%
group_by(defteam) %>%
summarise(
EPA_allowed = median(OFF_EPA_allowed),
ypp_allowed = median(ypp),
pass_ypa_allowed = median(pass_ypa),
rush_ypa_allowed = median(rush_ypa),
turnovers_forced = median(interceptions_forced)+median(fumbles_forced)
)
agg <- off %>%
inner_join(def, c('posteam'='defteam'))
teams<-agg$posteam
agg <- agg %>%
select(-posteam)
rownames(agg) <- teams
teams_pca <- prcomp(agg, center = TRUE, scale = TRUE)
fviz_pca_biplot(rushers_pca, geom = c("point", "text")) +
xlim(-6, 3) +
labs(title = "**PCA Biplot: PC1 and PC2**") +
xlab("PC1 - 35.8%") +
ylab("PC2 - 24.6%")
fviz_pca_biplot(teams_pca, geom = c("point", "text")) +
xlim(-6, 3) +
labs(title = "**PCA Biplot: PC1 and PC2**") +
xlab("PC1 - 35.8%") +
ylab("PC2 - 24.6%")
get_eigenvalue(teams_pca)
fviz_eig(rushers_pca, addlabels = TRUE) +
xlab("Principal Component") +
ylab("% of Variance Explained") +
labs(title = "**PCA Analysis: Scree Plot**")
fviz_eig(teams_pca, addlabels = TRUE) +
xlab("Principal Component") +
ylab("% of Variance Explained") +
labs(title = "**PCA Analysis: Scree Plot**")
pc1 <- fviz_contrib(teams_pca, choice = "var", axes = 1)
pc2 <- fviz_contrib(teams_pca, choice = "var", axes = 2)
pc3 <- fviz_contrib(teams_pca, choice = "var", axes = 3)
pc4 <- fviz_contrib(teams_pca, choice = "var", axes = 4)
pc5 <- fviz_contrib(teams_pca, choice = "var", axes = 5)
plot_grid(pc1, pc2, pc3, pc4, pc5)
k <- 5
pca_scores <- teams_pca$x
team_kmeans <- kmeans(pca_scores, centers = k)
team_kmeans$cluster
cluster_assignment <- team_kmeans$cluster
agg$cluster <- cluster_assignment
kmean_dataviz <- agg %>%
mutate(cluster = case_when(
cluster == 1 ~ "Cluster 1",
cluster == 2 ~ "Cluster 2",
cluster == 3 ~ "Cluster 3",
cluster == 4 ~ "Cluster 4",
cluster == 5 ~ "Cluster 5"))
kmean_data_long <- kmean_dataviz %>%
gather("Variable", "Value", -cluster)
ggplot(kmean_data_long, aes(x = Variable, y = Value, color = cluster)) +
geom_point(size = 3) +
facet_wrap(~ cluster) +
scale_color_brewer(palette = "Set1") +
gghighlight(use_direct_label = FALSE) +
theme(axis.text = element_text(angle = 90, size = 8),
strip.text = element_text(face = "bold"),
legend.position = "none")
View(kmean_dataviz)
View(team_kmeans)
team_kmeans$cluster
library(nflfastR)
library(tidyverse)
library(nflplotR)
library(ggplot2)
library(extrafont)
library(ggrepel)
library(ggimage)
library(ggridges)
library(ggtext)
library(ggfx)
library(geomtextpath)
library(cropcircles)
library(magick)
library(glue)
library(gt)
library(gtExtras)
library(nflverse)
### prelim ###
week=17
YPP<-function(season=2024,week){
info <- nflfastR::teams_colors_logos
nfc <- info %>%
filter(team_conf == "NFC")
afc <- info %>%
filter(team_conf == "AFC")
### creating function to add SD, mean, and mean + sd
meansd <- function(x, ...) {
mean <- mean(x)
sd <- sd(x)
c(mean - sd, mean, mean + sd)
}
pbp <- load_pbp(c(2023,2024))
pbp <- add_qb_epa(pbp)
players<-calculate_player_stats(pbp=pbp)
quarterbacks<-players[which(players$position == "QB"),'player_id']
qb_map <-  pbp %>%
filter(season_type == "REG" & down %in% c(1, 2, 3, 4) & punt_attempt == 0
& passer_player_id %in% quarterbacks$player_id
& season %in% c(2023,2024)) %>%
group_by(passer_player_id,posteam_type) %>%
summarise(
QB_name = max(passer_player_name,na.rm = TRUE),
QB_EPA = median(qb_epa,na.rm = TRUE),
pass_ypa =  sum(passing_yards,na.rm = TRUE)/sum(pass_attempt,na.rm = TRUE)
)
## ---------------------------- function ---------------------------- ##
NFL_YPP_SPREAD <- function(home_id, away_id, QBH, QBA) {
info <- nflfastR::teams_colors_logos
nfc <- info %>%
filter(team_conf == "NFC")
afc <- info %>%
filter(team_conf == "AFC")
### creating function to add SD, mean, and mean + sd
meansd <- function(x, ...) {
mean <- mean(x)
sd <- sd(x)
c(mean - sd, mean, mean + sd)
}
pbp <- load_pbp(c(2023,2024))
pbp <- add_qb_epa(pbp)
players<-calculate_player_stats(pbp=pbp)
quarterbacks<-players[which(players$position == "QB"),'player_id']
qb_map <-  pbp %>%
filter(season_type == "REG" & down %in% c(1, 2, 3, 4) & punt_attempt == 0
& passer_player_id %in% quarterbacks$player_id
& season %in% c(2023,2024)) %>%
group_by(passer_player_id,posteam_type) %>%
summarise(
QB_name = max(passer_player_name,na.rm = TRUE),
QB_EPA = median(qb_epa,na.rm = TRUE),
pass_ypa =  sum(passing_yards,na.rm = TRUE)/sum(pass_attempt,na.rm = TRUE)
)
df_off <- pbp %>%
filter(season_type == "REG", down %in% c(1, 2, 3, 4), punt_attempt == 0) %>%
group_by(posteam, game_id )%>%
summarise(
OFF_EPA = mean(epa, na.rm = TRUE),
QB_EPA = mean(qb_epa,na.rm = TRUE),
QB = max(passer_player_name,na.rm = TRUE),
fumble = sum(fumble_lost),
interception = sum(interception),
pass_ypa = sum(passing_yards,na.rm = TRUE)/sum(pass_attempt,na.rm = TRUE),
rush_ypa = sum(rushing_yards,na.rm = TRUE)/sum(rush_attempt,na.rm = TRUE),
pass_yds = sum(passing_yards,na.rm = TRUE),
rush_yds = sum(rushing_yards,na.rm = TRUE),
ypp = sum(sum(rushing_yards,na.rm = TRUE) + sum(passing_yards,na.rm = TRUE))/n(),
drives = max(drive,na.rm = TRUE)/2,
#    home_points = max(home_score,na.rm = TRUE),
#    away_points = max(away_score,na.rm = TRUE),
home_team = max(home_team,na.rm = TRUE),
pressures_allowed = (sum(sack,na.rm = TRUE)+sum(qb_hit,na.rm = TRUE) ),
total_plays_off = n(),
points = if_else(max(posteam,na.rm = TRUE) == max(home_team,na.rm = TRUE), max(home_score,na.rm = TRUE),max(away_score,na.rm = TRUE))
)
df_def<- pbp %>%
filter(season_type == "REG", down %in% c(1, 2, 3, 4), punt_attempt == 0) %>%
group_by(defteam, game_id )%>%
summarise(
OFF_EPA_allowed = mean(epa, na.rm = TRUE),
QB_EPA_allowed = mean(qb_epa,na.rm = TRUE),
#QB = max(passer_player_name,na.rm = TRUE),
fumbles_forced = sum(fumble_lost),
interceptions_forced = sum(interception),
pass_ypa_allowed = sum(passing_yards,na.rm = TRUE)/sum(pass_attempt,na.rm = TRUE),
rush_ypa_allowed = sum(rushing_yards,na.rm = TRUE)/sum(rush_attempt,na.rm = TRUE),
pass_yds_allowed = sum(passing_yards,na.rm = TRUE),
rush_yds_allowed = sum(rushing_yards,na.rm = TRUE),
ypp_allowed = sum(sum(rushing_yards,na.rm = TRUE) + sum(passing_yards,na.rm = TRUE))/n(),
drives_allowed = max(drive,na.rm = TRUE)/2,
#    home_points = max(home_score,na.rm = TRUE),
#    away_points = max(away_score,na.rm = TRUE),
away_team = max(away_team,na.rm = TRUE),
pressures_forced = (sum(sack,na.rm = TRUE)+sum(qb_hit,na.rm = TRUE) ),
total_plays_def = n(),
points_allowed = if_else(max(defteam,na.rm = TRUE) == max(home_team,na.rm = TRUE), max(away_score,na.rm = TRUE),max(home_score,na.rm = TRUE))
)
df<-cbind(df_off,df_def)
####### INPUTS #########
# home_id = 'DET'; home_qb = 'J.Goff'
# away_id = 'LA';away_qb = 'M.Stafford'
#
home_qb = QBH
away_qb = QBA
######## code #########
home_df <- df %>%
filter(posteam == home_id | defteam == home_id)
away_df <- df %>%
filter(posteam == away_id | defteam == away_id)
# n_train <- sample(seq(1,nrow(df),1) , .75*nrow(df))
# n_test <- seq(1,nrow(df),1) [!(seq(1,nrow(df),1) %in% n_train)]
#
#
# team_df <- df %>%
#   filter(posteam == id | defteam == id)
#
# n_train <- sample(seq(1,nrow(team_df),1) , .75*nrow(team_df))
# n_test <- seq(1,nrow(team_df),1) [!(seq(1,nrow(team_df),1) %in% n_train)]
# team_df['turnovers']<-team_df$interception + team_df$fumble
# team_df['turnovers_forced']<-team_df$interceptions_forced + team_df$fumbles_forced
#
# train_rows = team_df[n_train,]
# test_rows = team_df[n_test,]
home_df['turnovers']<-home_df$interception + home_df$fumble
home_df['turnovers_forced']<-home_df$interceptions_forced + home_df$fumbles_forced
away_df['turnovers']<-away_df$interception + away_df$fumble
away_df['turnovers_forced']<-away_df$interceptions_forced + away_df$fumbles_forced
################################ home ##############################
off_model_home <- lm(ypp ~ turnovers + pass_ypa + rush_ypa +
+ OFF_EPA + pressures_allowed + OFF_EPA_allowed + drives,data = home_df)
def_model_home <- lm(ypp_allowed ~  turnovers_forced + pass_ypa_allowed + rush_ypa_allowed + OFF_EPA_allowed
+ OFF_EPA + pressures_forced + drives,data = home_df)
################################ away ##############################
off_model_away <- lm(ypp ~ turnovers + pass_ypa + rush_ypa +
+ OFF_EPA + pressures_allowed + OFF_EPA_allowed + drives,data = away_df)
def_model_away <- lm(ypp_allowed ~  turnovers_forced + pass_ypa_allowed + rush_ypa_allowed + OFF_EPA_allowed
+ OFF_EPA + pressures_forced + drives,data = away_df)
summary(off_model_home);summary(def_model_home)
summary(off_model_away);summary(def_model_away)
# qb_home_input = ifelse(QBH != FALSE, pull(qb_map[which(qb_map$QB_name == home_qb & qb_map$posteam_type == 'home'),'QB_EPA']), 0) #Home QB EPA
# qb_away_input = ifelse(QBA != FALSE, pull(qb_map[which(qb_map$QB_name == away_qb & qb_map$posteam_type == 'away'),'QB_EPA']), 0) #Away QB EPA
qb_home_input = ifelse(QBH != FALSE, pull(qb_map[which(qb_map$QB_name == home_qb ),'QB_EPA']), 0) #Home QB EPA
qb_away_input = ifelse(QBA != FALSE, pull(qb_map[which(qb_map$QB_name == away_qb),'QB_EPA']), 0) #Away QB EPA
new_home_df <- tibble(turnovers = ( median(home_df$turnovers,na.rm = TRUE) + median(away_df$turnovers_forced,na.rm = TRUE)) /2,
pass_ypa  = ( pull(qb_map[which(qb_map$QB_name == home_qb),'pass_ypa'])+median(away_df$pass_ypa_allowed,na.rm = TRUE))/2,
rush_ypa =  ( median(home_df$rush_ypa,na.rm = TRUE) + median(away_df$rush_ypa_allowed,na.rm = TRUE)) /2,
OFF_EPA =  (qb_home_input + median(away_df$OFF_EPA_allowed,na.rm = TRUE))/2,
pressures_allowed = ( median(home_df$pressures_allowed,na.rm = TRUE) + median(away_df$pressures_forced,na.rm = TRUE)) /2,
drives = ( median(home_df$drives,na.rm = TRUE) + median(away_df$drives_allowed,na.rm = TRUE)) /2,
turnovers_forced = ( median(home_df$turnovers_forced,na.rm = TRUE) + median(away_df$turnovers,na.rm = TRUE)) /2,
pass_ypa_allowed = ( median(home_df$pass_ypa_allowed,na.rm = TRUE) + median(away_df$pass_ypa,na.rm = TRUE)) /2,
rush_ypa_allowed = ( median(home_df$rush_ypa_allowed,na.rm = TRUE) + median(away_df$rush_ypa,na.rm = TRUE)) /2,
OFF_EPA_allowed = ( qb_away_input + median(home_df$OFF_EPA_allowed,na.rm = TRUE))/2,
pressures_forced = ( median(away_df$pressures_allowed,na.rm = TRUE) + median(home_df$pressures_forced,na.rm = TRUE)) /2,
)
new_away_df <- tibble(turnovers = ( median(away_df$turnovers,na.rm = TRUE) + median(home_df$turnovers_forced,na.rm = TRUE)) /2,
pass_ypa  = ( pull(qb_map[which(qb_map$QB_name == away_qb),'pass_ypa'])+median(home_df$pass_ypa_allowed,na.rm = TRUE))/2,
rush_ypa =  ( median(away_df$rush_ypa,na.rm = TRUE) + median(home_df$rush_ypa_allowed,na.rm = TRUE)) /2,
OFF_EPA =  ( qb_away_input+ median(home_df$OFF_EPA_allowed,na.rm = TRUE))/2,
pressures_allowed = ( median(away_df$pressures_allowed,na.rm = TRUE) + median(home_df$pressures_forced,na.rm = TRUE)) /2,
drives = ( median(away_df$drives,na.rm = TRUE) + median(home_df$drives_allowed,na.rm = TRUE)) /2,
turnovers_forced = ( median(away_df$turnovers_forced,na.rm = TRUE) + median(home_df$turnovers,na.rm = TRUE)) /2,
pass_ypa_allowed = ( median(away_df$pass_ypa_allowed,na.rm = TRUE) + median(home_df$pass_ypa,na.rm = TRUE)) /2,
rush_ypa_allowed = ( median(away_df$rush_ypa_allowed,na.rm = TRUE) + median(home_df$rush_ypa,na.rm = TRUE)) /2,
OFF_EPA_allowed = ( qb_home_input + median(away_df$OFF_EPA_allowed,na.rm = TRUE))/2,
pressures_forced = ( median(home_df$pressures_allowed,na.rm = TRUE) + median(away_df$pressures_forced,na.rm = TRUE)) /2,
)
home_diff = predict(off_model_home,newdata = new_home_df)-predict(def_model_home,newdata = new_home_df)
away_diff = predict(off_model_away,newdata = new_away_df)-predict(def_model_away,newdata = new_away_df)
home_spread <- -(home_diff - away_diff)/.2
print(-(home_diff - away_diff)/.2);print(summary(off_model_home))
y<- tibble( home = home_id,
home_off_ypp = predict(off_model_home,newdata = new_home_df),
home_def_ypp = predict(def_model_home,newdata = new_home_df),
home_ypp_diff = home_diff,
away = away_id,
away_off_ypp = predict(off_model_away,newdata = new_away_df),
away_def_ypp = predict(def_model_away,newdata = new_away_df),
away_ypp_diff = away_diff
)
return(y)
}
## ----------------------------  ---------------------------- ##
# season = 2024
# week = 2
schedule <- load_schedules(seasons = season)
schedule <- schedule[which(schedule$week == week),]
schedule['away_total']<-schedule$total_line/2 - schedule$spread_line/2
schedule['home_total']<-schedule$total_line/2 + schedule$spread_line/2
schedule['home_ypp']=0;schedule['away_ypp']=0
ypp_proj<-tibble()
for (game in 1:nrow(schedule)){
y<-NFL_YPP_SPREAD(home_id = schedule$home_team[game],away_id = schedule$away_team[game],
QBH = qb_map$QB_name[which(qb_map$passer_player_id == schedule$home_qb_id[game])][1],
QBA = qb_map$QB_name[which(qb_map$passer_player_id == schedule$away_qb_id[game])][1])
ypp_proj<-rbind(ypp_proj,y)
}
return(ypp_proj)
}
y<-YPP(2024,week=17)
y
y$home_spread <- -(y$home_ypp_diff - y$away_ypp_diff)/.2
y
View(y)
result <- y %>%
mutate(group = ceiling(row_number() / 2)) %>% # Create a grouping variable
group_by(home) %>%                           # Group every two rows
summarize(across(everything(), mean), .groups = "drop") # Compute the average
result <- y %>%
mutate(group = ceiling(row_number() / 2)) %>% # Create a grouping variable
group_by(group) %>%                           # Group every two rows
summarize(across(everything(), mean), .groups = "drop") # Compute the average
result
y
odd_home <- y$home[seq(1, nrow(df), by = 2)]
even_home<- y$home[seq(2, nrow(df), by = 2)]
odd_home
even_home<- y$home[seq(2, nrow(y), by = 2)]
even_home
y$home<-odd_home
y
result$home<-odd_home
result
odd_home
result['home']<-odd_home
odd_home
odd_home
odd_home <- y$home[seq(1, nrow(y), by = 2)]
even_home<- y$home[seq(2, nrow(y), by = 2)]
odd_away <- y$away[seq(1, nrow(y), by = 2)]
even_away<- y$away[seq(2, nrow(y), by = 2)]
result['home']<-odd_home
result['away']<-odd_away
result
# Chunk 1: setup
knitr::opts_chunk$set(echo = TRUE)
library(nflfastR)
library(tidyverse)
library(nflplotR)
library(ggplot2)
library(extrafont)
library(ggrepel)
library(ggimage)
library(ggridges)
library(ggtext)
library(ggfx)
library(geomtextpath)
library(cropcircles)
library(magick)
library(glue)
library(gt)
library(gtExtras)
library(nflverse)
library(xgboost)
library(xtable)
library(rvest)
library(dplyr)
library(tidyr)
library(stringr)
library(htmltools)
library(htmlwidgets)
library(reactable)
library(stringdist)
library(nflfastR)
library(nflreadr)
library(nflverse)
library(stringr)
library(tidyverse)
library(nnet)
library(mgcv)
library(texreg)
library(aod)
library(xtable)
library(xgboost)
library(readr)
library(stringr)
library(caret)
library(car)
library(tidyverse)
library(gt)
library(gsisdecoder)
library(reticulate)
setwd("/Users/HarrisonEller/Documents/Statletics/Repositories/NFL_Analytics")
source('nfl_ypp_model.r')
# Chunk 2
week=22
xgb=TRUE
# Chunk 3
### ypp model ###
if (FALSE){
ypp_proj<-YPP(season=2024,week=week)
rows <- nrow(ypp_proj)
odd_rows <- seq_len(rows) %% 2
# getting data from odd data frame
data_mod <- ypp_proj[odd_rows == 1, ]
ypp_inp=TRUE
}else(ypp_inp=FALSE)
# Chunk 4
from points_model import nfl_model
knitr::opts_chunk$set(echo = TRUE)
library(nflfastR)
library(tidyverse)
library(nflplotR)
library(ggplot2)
library(extrafont)
library(ggrepel)
library(ggimage)
library(ggridges)
library(ggtext)
library(ggfx)
library(geomtextpath)
library(cropcircles)
library(magick)
library(glue)
library(gt)
library(gtExtras)
library(nflverse)
library(xgboost)
library(xtable)
library(rvest)
library(dplyr)
library(tidyr)
library(stringr)
library(htmltools)
library(htmlwidgets)
library(reactable)
library(stringdist)
library(nflfastR)
library(nflreadr)
library(nflverse)
library(stringr)
library(tidyverse)
library(nnet)
library(mgcv)
library(texreg)
library(aod)
library(xtable)
library(xgboost)
library(readr)
library(stringr)
library(caret)
library(car)
library(tidyverse)
library(gt)
library(gsisdecoder)
library(reticulate)
setwd("/Users/HarrisonEller/Documents/Statletics/Repositories/NFL_Analytics")
source('nfl_ypp_model.r')
week=22
xgb=TRUE
### ypp model ###
if (FALSE){
ypp_proj<-YPP(season=2024,week=week)
rows <- nrow(ypp_proj)
odd_rows <- seq_len(rows) %% 2
# getting data from odd data frame
data_mod <- ypp_proj[odd_rows == 1, ]
ypp_inp=TRUE
}else(ypp_inp=FALSE)
reticulate::repl_python()
